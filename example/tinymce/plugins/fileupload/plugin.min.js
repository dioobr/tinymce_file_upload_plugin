tinymce.PluginManager.add('fileupload', function(a, b){
	a.settings.file_browser_callback = function(id, value, type, win){
		var ibc = $('#'+id.substring(0, id.indexOf('-')+1)+'open');
		if(ibc.hasClass('processing')) return false;
		var ipci = ibc.parent().next('input[type="file"]');
		if(!ipci.length){
			ipci = $('<input />').attr({type: 'file'}).css('display', 'none');
			ibc.parent().after(ipci);
			ipci.change(function(){
				var fi = this.files[0];
				if(fi.name.indexOf('.') == -1){
					tinyMCE.activeEditor.windowManager.alert('Error: The selected file does not have an extension.');
					return false;
				}
				var fex = fi.name.split('.').pop().toLowerCase();
				if(type == 'image' && $.inArray(fex, ['gif', 'jpg', 'png']) == -1){
					tinyMCE.activeEditor.windowManager.alert('Please select an image file (JPG, GIF or PNG).');
					return false;
				}
				if(type == 'media' && $.inArray(fex, ['mp4', 'ogg', 'ogv', 'webm']) == -1){
					tinyMCE.activeEditor.windowManager.alert('Please select a video file (MP4, OGG/OGV or WebM).');
					return false;
				}			
				ibc.addClass('processing');
				var data = new FormData();
				data.append('upfile', fi);

			    $.ajax({
			        url: b+'/upload.php',
			        type: 'POST',
			        data: data,
			        global: false,
			        dataType: 'json',
			        success: function(r){
			        	ibc.removeClass('processing');
			        	if(r.response.code != "Y001"){
			        		alert(r.response.message);
			        		return false;
			        	}
			        	var ipu = $('#'+id);
			        	ipu.val(r.data.file.url);
			        	if($.inArray(r.data.file.mime_type, ['image/gif', 'image/png', 'image/jpeg']) != -1){
				        	var mp = ipu.parents().eq(3);
				        	mp.find('input[aria-label="Width"]').val(r.data.width);
				        	mp.find('input[aria-label="Height"]').val(r.data.height);
			        	}
			        	return true;
			        },
			        cache: false,
			        contentType: false,
			        processData: false,
			        xhr: function(){
			            var myXhr = $.ajaxSettings.xhr();
			            if(myXhr.upload) myXhr.upload.addEventListener('error', function(){ alert('Error 00220: Failed to upload the selected file.'); }, false);					                
			        	return myXhr;
			        }
			    });	
			});			
		}
		ipci.trigger('click');
	}
});